{% comment %}
<!--
Example code for the CloudFlare mail protection script.
CloudFlare will inject this on every page, but due to Hydejack's push state approach to page loading,
it will only run on the initial page.
The snippet below will run the code on every `hy-push-state-load` event instead.
-->
<script>
  document.getElementById('_pushState').addEventListener('hy-push-state-load', function (e) {
    function e(e){
      (console.error?console.error:console.log).call(console,e)
    }

    function t(e){
      return l.innerHTML='<a href="'+e.replace(/"/g,"&quot;")+'"></a>',l.childNodes[0].getAttribute("href")
    }

    function r(e,t){
      var r=e.substr(t,2);return parseInt(r,16)
    }

    function n(e,n){
      for(var o="",c=r(e,n),a=n+2;a<e.length;a+=2){
        var l=r(e,a)^c;
        o+=String.fromCharCode(l)
      }
      return t(o)
    }

    var o="/cdn-cgi/l/email-protection#",
        c=".__cf_email__",
        a="data-cfemail",
        l=document.createElement("div");

    !function(){
      for(var t=document.getElementsByTagName("a"),r=0;r<t.length;r++)
        try{
          var c=t[r],a=c.href.indexOf(o);
          a>-1&&(c.href="mailto:"+n(c.href,a+o.length))
        }catch(t){
          e(t)
        }
    }(),
    function(){
      for(var t=document.querySelectorAll(c),r=0;r<t.length;r++)
        try{
          var o=t[r],l=n(o.getAttribute(a),0),i=document.createTextNode(l);
          o.parentNode.replaceChild(i,o)
        }catch(t){
          e(t)
        }
    }()
  });
</script>
{% endcomment %}

{% if site.lightbox %}
  <script src="/assets/js/lightbox.js"></script>
{% endif %}

<script>
  document
    .getElementById("_pushState")
    .addEventListener("hy-push-state-load", function () {
      apply_lightbox();
    });
</script>

<script>
function initCiteModals() {
  // Open modal
  document.querySelectorAll('.cite-btn').forEach(function(btn) {
    btn.onclick = function() {
      var id = btn.getAttribute('data-cite');
      var modal = document.getElementById('modal-' + id);
      if (modal) modal.style.display = 'flex';
    };
  });
  // Close modal
  document.querySelectorAll('.close-modal').forEach(function(span) {
    span.onclick = function() {
      var id = span.getAttribute('data-cite');
      var modal = document.getElementById('modal-' + id);
      if (modal) modal.style.display = 'none';
    };
  });
  // Close on background click
  document.querySelectorAll('.modal').forEach(function(modal) {
    modal.onclick = function(e) {
      if (e.target === modal) modal.style.display = 'none';
    };
  });
}

document.addEventListener('DOMContentLoaded', initCiteModals);

var pushState = document.getElementById('_pushState');
if (pushState) {
  pushState.addEventListener('hy-push-state-load', initCiteModals);
}
</script>

<script>
function initFootnoteTooltips() {
  // Create tooltip element
  const tooltip = document.createElement('div');
  tooltip.className = 'footnote-tooltip';
  document.body.appendChild(tooltip);
  
  // Cache footnote content
  const footnoteCache = {};
  document.querySelectorAll('.footnotes > ol > li').forEach(function(li) {
    const id = li.id;
    if (id && id.startsWith('fn:')) {
      const key = id.replace('fn:', '');
      // Get text content, preserving links
      const content = li.innerHTML;
      footnoteCache[key] = content;
    }
  });
  
  let currentTimeout = null;
  let currentLink = null;
  
  function showTooltip(link, content) {
    if (currentTimeout) {
      clearTimeout(currentTimeout);
    }
    
    const rect = link.getBoundingClientRect();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
    
    tooltip.innerHTML = content;
    
    // Position tooltip above the link, centered horizontally
    let leftPos = rect.left + scrollLeft + (rect.width / 2) - 200;
    let topPos = rect.top + scrollTop - 10;
    
    tooltip.style.left = leftPos + 'px';
    tooltip.style.top = topPos + 'px';
    tooltip.classList.add('visible');
    
    // Adjust position if tooltip goes off screen
    setTimeout(function() {
      const tooltipRect = tooltip.getBoundingClientRect();
      const tooltipWidth = tooltipRect.width;
      const tooltipHeight = tooltipRect.height;
      
      // Horizontal adjustments
      if (tooltipRect.right > window.innerWidth) {
        tooltip.style.left = (window.innerWidth - tooltipWidth - 20) + 'px';
      }
      if (tooltipRect.left < 0) {
        tooltip.style.left = '20px';
      }
      
      // Vertical adjustments - show below if not enough space above
      if (tooltipRect.top < 0) {
        tooltip.style.top = (rect.bottom + scrollTop + 10) + 'px';
      }
      
      // If still off screen, try centering vertically
      const finalRect = tooltip.getBoundingClientRect();
      if (finalRect.top < 0) {
        tooltip.style.top = (window.innerHeight / 2 - tooltipHeight / 2) + 'px';
      }
    }, 0);
    
    currentLink = link;
  }
  
  function hideTooltip() {
    if (currentTimeout) {
      clearTimeout(currentTimeout);
    }
    currentTimeout = setTimeout(function() {
      tooltip.classList.remove('visible');
      currentLink = null;
    }, 100);
  }
  
  // Handle footnote links
  document.querySelectorAll('a[href^="#fn:"]').forEach(function(link) {
    const href = link.getAttribute('href');
    const key = href.replace('#fn:', '');
    
    if (footnoteCache[key]) {
      // Mouse enter - show tooltip
      link.addEventListener('mouseenter', function(e) {
        e.preventDefault();
        showTooltip(link, footnoteCache[key]);
      });
      
      // Mouse leave - hide tooltip
      link.addEventListener('mouseleave', function() {
        hideTooltip();
      });
      
      // Click - still navigate but show tooltip first
      link.addEventListener('click', function(e) {
        // Don't prevent default - allow navigation
        // But show tooltip briefly
        showTooltip(link, footnoteCache[key]);
        setTimeout(function() {
          hideTooltip();
        }, 2000);
      });
    }
  });
  
  // Hide tooltip when clicking elsewhere
  document.addEventListener('click', function(e) {
    if (!e.target.closest('a[href^="#fn:"]') && e.target !== tooltip && !tooltip.contains(e.target)) {
      hideTooltip();
    }
  });
  
  // Hide tooltip on scroll
  window.addEventListener('scroll', function() {
    hideTooltip();
  }, true);
}

document.addEventListener('DOMContentLoaded', initFootnoteTooltips);

var pushStateFootnote = document.getElementById('_pushState');
if (pushStateFootnote) {
  pushStateFootnote.addEventListener('hy-push-state-load', initFootnoteTooltips);
}
</script>

